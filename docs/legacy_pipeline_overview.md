# Legacy Segmentation & Build Pipeline Overview

## 1. Introduction

This document provides a detailed description of the legacy `morphseq` image processing pipeline as implemented outside of the `segmentation_sandbox`. Its purpose is to take raw 2D or 3D brightfield image data, identify and segment key components like embryos and yolks, track embryos over time, perform quality control, and export processed image "snips" for downstream analysis.

Understanding this existing workflow is crucial for integrating new segmentation pipelines and for general project maintenance.

## 2. Core Dependencies

- **Environment:** The pipeline runs in the `torch-env` conda environment.
- **Key Libraries:**
    - `pytorch`: The core deep learning framework.
    - `pytorch-lightning`: Used as a high-level wrapper for the model definition.
    - `segmentation-models-pytorch`: Provides the Feature Pyramid Network (FPN) architecture and ResNet encoders. This is a critical dependency.
    - `scikit-image`: Used extensively for image manipulation (resizing, labeling, region properties).
    - `pandas`: Used for all metadata manipulation.
    - `nd2`: Used for reading raw `.nd2` z-stack files from the YX1 microscope.

## 3. Pipeline Flow

The pipeline is a multi-stage process, orchestrated by a series of `build` scripts. Each stage produces outputs that are consumed by the next.

---

### **Stage 1: Sequential Mask Generation**

This stage generates all the necessary segmentation masks for downstream processing. It does **not** use a single multi-target model, but rather a series of individual models run sequentially.

- **Script:** `src/build/build02B_segment_bf_main.py`
- **Entry Point:** The `apply_unet` function is the core worker. The `if __name__ == "__main__"` block calls this function four times in a row.

#### **Process:**

1.  **Model Definition:** The script uses the `FishModel` class defined in `src/functions/core_utils_segmentation.py`. This class implements a **Feature Pyramid Network (FPN)** with a **ResNet34** encoder backbone, provided by the `segmentation-models-pytorch` library.

2.  **Sequential Execution:** `apply_unet` is called once for each required mask, loading a different set of pre-trained weights each time. The typical execution order is:
    1.  **Embryo/Viability Segmentation** (`unet_emb_v4_0050`): A 2-class model to distinguish living vs. dead embryo regions.
    2.  **Bubble Segmentation** (`unet_bubble_v0_0050`): A 1-class model to identify air bubbles.
    3.  **Yolk Segmentation** (`unet_yolk_v0_0050`): A 1-class model to identify the embryo yolk.
    4.  **Focus Segmentation** (`unet_focus_v2_0050`): A 1-class model to identify out-of-focus regions.

#### **Inputs:**

-   **Images:** Raw 2D brightfield images (JPG, PNG, TIF) located in `built_image_data/stitched_FF_images/<experiment_date>/`.
-   **Model Weights:** Pre-trained `.pth` model files located in `segmentation/segmentation_models/`.

#### **Outputs:**

-   **Crucial Point:** Each model saves its predictions to a **separate directory**.
-   **Location:** `segmentation/<model_name>_predictions/<experiment_date>/`
-   **Format:** The output masks are single-channel 8-bit **JPG files**. They are **not** simple binary (0/255) masks. The pixel values are multi-level integers (e.g., 85, 170, 255) that encode class information based on the model's output probabilities. Downstream scripts must interpret these values correctly.

---

### **Stage 2: 2D Embryo Tracking and QC Analysis**

This stage takes the 2D masks from Stage 1, identifies and tracks individual embryos over time, and performs quality control checks.

- **Script:** `src/build/build03A_process_images.py`
- **Entry Points:** `segment_wells` followed by `compile_embryo_stats`.

#### **Process:**

1.  **Embryo Detection (`count_embryo_regions`):**
    -   Loads the embryo mask generated by `unet_emb_v4_0050`.
    -   **Implicit Binarization:** It converts the multi-level JPG mask into a binary mask using a mathematical operation that acts as a threshold (e.g., `(np.round(im / 255 * 2) - 1)`).
    -   Uses `skimage.measure.label` on the binarized mask to find distinct embryo objects.
    -   Extracts the centroid and a temporary `region_label` for each detected embryo.
    -   Uses the viability mask to calculate the `frac_alive` for each embryo.

2.  **Temporal Tracking (`do_embryo_tracking`):**
    -   Takes the per-frame embryo detections (centroids).
    -   Uses a linear sum assignment algorithm based on proximity to track each unique embryo over time, assigning it a stable `embryo_id`.

3.  **Quality Control (`get_embryo_stats`):**
    -   For each tracked embryo, this function loads the full set of masks from Stage 1 (embryo, yolk, bubble, focus).
    -   It uses the stored `region_label` to isolate the specific embryo of interest from the embryo mask.
    -   It performs a series of QC checks by comparing the embryo's location to the other masks, setting flags like `no_yolk_flag`, `focus_flag`, and `bubble_flag`.
    -   It calculates morphological statistics like `length_um`, `width_um`, and `surface_area_um`.

#### **Inputs:**

-   The various segmentation masks generated in Stage 1.

#### **Outputs:**

-   **Master Metadata File:** A rich CSV file (`embryo_metadata_df.csv`) containing a row for every detected embryo at every timepoint, including its ID, position, QC flags, and morphological stats. This file is the primary input for the final stage.

---

### **Stage 3: 3D Z-Stack Processing & Snippet Export**

The final stage uses the 2D tracking data to find the best focal plane in the original 3D image stacks and export high-quality 2D image snips.

- **Script:** `src/build/build03B_export_z_snips.py`
- **Entry Point:** `extract_embryo_z_snips`

#### **Process:**

1.  **Data Loading:**
    -   Loads the master metadata CSV produced by Stage 2.
    -   For a given embryo, it loads the original raw 3D image stack (either a `.nd2` file or a `.tif` stack).
    -   It also re-loads the 2D embryo and yolk masks from Stage 1.

2.  **Focus Calculation (`LoG_focus_stacker`):**
    -   **Critical Dependency:** To find the most in-focus z-slice, the script calculates focus scores (using a Laplacian of Gaussian filter) **only on the embryo "body"**.
    -   The body is defined by **subtracting the yolk mask from the embryo mask**. This means the yolk mask is essential for this calculation to work as intended.

3.  **Image Processing & Export (`export_embryo_snips_z`):**
    -   Once the optimal z-slice is found, the script orients the image using the embryo and yolk masks (`get_embryo_angle`).
    -   It rotates and crops a standardized "snip" from the selected z-slice.
    *   It saves the final processed 2D snip to `training_data/bf_embryo_snips_z<N>/`.

#### **Inputs:**

-   The metadata CSV from Stage 2.
-   The raw 3D image stacks (e.g., `.nd2` files).
-   The 2D embryo and yolk masks from Stage 1.

#### **Outputs:**

-   Final, processed, 2D brightfield image snips of each embryo, taken from the optimal focal plane.
