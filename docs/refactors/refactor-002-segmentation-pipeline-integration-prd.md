wa# Refactor PRD 002: Full Segmentation Pipeline Integration

## 1. Objective

Fully replace the legacy U-Net embryo segmentation and its fragile, position-based tracking system with the superior SAM2 pipeline. This refactor will completely remove the dependency on the `region_label` system by using the robust, instance-aware integer masks generated by the segmentation sandbox.

## 2. Status

- **Phase 0 (Prerequisite):** Complete. Both U-Net and SAM2 segmentation pipelines can be run successfully.
  - U-Net masks (yolk, bubble, focus) are generated in `segmentation/`.
  - SAM2 embryo masks (integer-labeled) are generated in `segmentation/sam2_embryo_masks/`.

## 3. Core Analysis & Strategy

### 3.1. The `region_label` Problem
The legacy `region_label` system is a complex workaround for the U-Net pipeline's inability to produce instance-aware masks. It involves finding blobs of pixels and then running a separate, error-prone tracking algorithm (`do_embryo_tracking`) to guess which blob corresponds to which embryo over time.

### 3.2. The SAM2 Solution
The SAM2 pipeline's output makes the entire `region_label` system obsolete. Its masks are integer-labeled, where the pixel value itself is the embryo's ID, and this ID is stable across all frames. **Tracking is already embedded in the mask data.**

### 3.3. The Refactoring Strategy
The strategy is a surgical replacement of the old tracking logic within the build scripts, leaving the surrounding QC pipeline (which uses other masks) intact.

1.  **Remove Old Tracking:** Eliminate the `do_embryo_tracking` function and the creation/use of the `region_label` column.
2.  **Adapt to SAM2 Data:** Modify data processing functions to read embryo identity directly from the pixel values of SAM2's integer-labeled masks.
3.  **Preserve QC:** Ensure the logic that loads and uses auxiliary masks (yolk, bubble, focus) from the U-Net pipeline remains functional.

---

## 4. Implementation Plan

The implementation will focus exclusively on modifying the primary build script: `src/build/build03A_process_images.py`.

### **Phase 2.1: Eliminate Old Tracking System**

**Task:** Remove the `do_embryo_tracking` function entirely.
- **File:** `src/build/build03A_process_images.py`
- **Justification:** Its sole purpose was to generate stable `embryo_id`s and `region_label`s. SAM2 provides stable IDs directly, making this function redundant.

### **Phase 2.2: Rewrite Embryo Counting and ID Logic**

**Task:** Refactor the `count_embryo_regions` function to read labels from SAM2 masks instead of creating them.
- **File:** `src/build/build03A_process_images.py`
- **Old Logic:**
  ```python
  im_mask, cb_mask = process_mask_images(...)
  im_mask_lb = label(im_mask) // Creates new labels
  regions = regionprops(im_mask_lb)
  // ... loop ...
  row.loc["e" + str(i_pass) + "_label"] = r.label // Stores temporary label
  ```
- **New Logic:**
  ```python
  # Load the integer-labeled SAM2 mask directly
  sam2_mask = io.imread(sam2_mask_path)
  
  # Use regionprops on the already-labeled mask
  regions = regionprops(sam2_mask)
  
  # ... loop through regions ...
  # The label IS the embryo number
  embryo_num = region.label 
  # The stable embryo_id can be constructed immediately
  embryo_id = f"{well_id}_e{embryo_num:02}" 
  
  # Store centroid and the new, stable embryo_id. 
  # The "eX_label" column is no longer needed.
  row.loc["e" + str(i_pass) + "_x"] = region.centroid[1]
  row.loc["e" + str(i_pass) + "_y"] = region.centroid[0]
  row.loc["e" + str(i_pass) + "_embryo_id"] = embryo_id 
  ```

### **Phase 2.3: Adapt Downstream Mask Processing**

**Task:** Refactor `get_embryo_stats` to use the stable `embryo_id` for mask selection.
- **File:** `src/build/build03A_process_images.py`
- **Old Logic:**
  ```python
  im_mask_lb = label(im_mask)
  lbi = row["region_label"] // Uses fragile tracking result
  im_mask_lb = (im_mask_lb == lbi).astype(int)
  ```
- **New Logic:**
  ```python
  # Load the integer-labeled SAM2 mask
  sam2_mask = io.imread(sam2_mask_path)
  
  # Get the embryo number directly from the stable embryo_id
  embryo_num = int(row["embryo_id"].split('_e')[-1])
  
  # Select the specific embryo's mask
  im_mask_single_embryo = (sam2_mask == embryo_num).astype(int)
  ```

---

## 5. Data Structure Confirmation

- **`snip_id` Generation:** The existing logic for creating `snip_id` will be kept. It will now use the robust `embryo_id` generated from SAM2 data, making the final `snip_id` reliable.
  ```python
  tracked_df["snip_id"] = tracked_df["embryo_id"] + "_t" + tracked_df["time_int"].astype(str).str.zfill(4)
  ```
- **QC Mask Paths:** The logic for loading `yolk`, `bubble`, and `focus` masks will be verified but should require no changes, as those masks will still be generated by the U-Net pipeline into their expected locations.

## 6. Success Criteria

- [ ] The `do_embryo_tracking` function is successfully removed from `src/build/build03A_process_images.py`.
- [ ] The `region_label` column is fully eliminated from the data processing pipeline.
- [ ] Build scripts run end-to-end using SAM2 masks for embryo segmentation and U-Net masks for QC.
- [ ] The final metadata output contains stable, correct `embryo_id` and `snip_id` values derived from SAM2 data.
- [ ] Downstream QC flags (`no_yolk_flag`, `bubble_flag`, etc.) are generated correctly.

## 7. Files to Modify

1.  **`src/build/build03A_process_images.py`**: This is the primary file for modification. All logic for `region_label` creation, tracking, and usage will be removed and replaced with SAM2-aware logic.
