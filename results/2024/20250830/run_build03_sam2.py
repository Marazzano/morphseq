#!/usr/bin/env python3
"""
SAM2-Enhanced Build03A Runner Script

This script runs the complete Build03A pipeline using SAM2 embryo masks
with legacy yolk masks for optimal orientation. It replaces the legacy
regionprops-based segmentation with pre-computed SAM2 metadata.

Created: 2025-08-30
Purpose: Complete SAM2 MVP integration with legacy pipeline
"""

import sys
import os
from pathlib import Path
import multiprocessing

# Add project root to path and change to project directory
REPO_ROOT = Path(__file__).resolve().parents[2]
sys.path.insert(0, str(REPO_ROOT))
os.chdir(str(REPO_ROOT))

from src.build.build03A_process_images import segment_wells_sam2_csv, compile_embryo_stats, extract_embryo_snips

def main():
    """
    Run complete Build03A processing using SAM2 pipeline.
    
    This replaces the legacy segment_wells() approach with SAM2-based
    processing while maintaining full compatibility with Build04/05.
    """
    
    # Use the actual project root directory (not results directory)
    root = Path("/net/trapnell/vol1/home/mdcolon/proj/morphseq")
    
    # Production experiment with validated SAM2 data and yolk masks
    exp_name = "20250612_30hpf_ctrl_atf6"
    
    # Path to SAM2 metadata CSV (generated by segmentation_sandbox pipeline)
    sam2_csv_path = root / f"sam2_metadata_{exp_name}.csv"
    
    print(f"ğŸš€ Starting SAM2-Enhanced Build03A Pipeline")
    print(f"ğŸ“ Root: {root}")
    print(f"ğŸ§¬ Experiment: {exp_name}")
    print(f"ğŸ“Š SAM2 CSV: {sam2_csv_path}")
    print("="*60)
    
    # Step 1: Load SAM2 metadata and transform to legacy format
    print("ğŸ”„ Step 1: Loading SAM2 metadata...")
    tracked_df = segment_wells_sam2_csv(
        root=root, 
        exp_name=exp_name, 
        sam2_csv_path=sam2_csv_path
    )
    print(f"âœ… Loaded {len(tracked_df)} embryo tracking records")
    
    # Step 2: Compile embryo statistics (with enhanced QC)
    print("ğŸ“Š Step 2: Compiling embryo statistics...")
    stats_df = compile_embryo_stats(
        root=root, 
        tracked_df=tracked_df,
        overwrite_flag=False,
        ld_rat_thresh=0.9,
        qc_scale_um=150,
        n_workers=1  # Single-threaded for stability
    )
    print(f"âœ… Compiled stats for {len(stats_df)} embryos")
    
    # Step 3: Extract embryo snips with SAM2 masks + legacy yolk orientation
    print("ğŸ–¼ï¸ Step 3: Extracting embryo snips...")
    extract_embryo_snips(
        root=root,
        stats_df=stats_df,
        outscale=6.5,           # Standard pixel scale
        dl_rad_um=50,           # Distance learning radius  
        n_workers=1,            # Single-threaded for stability
        overwrite_flag=False    # Don't overwrite existing snips
    )
    
    print("ğŸ‰ SAM2-Enhanced Build03A Pipeline Complete!")
    print("="*60)
    print("ğŸ“ Output Locations:")
    print(f"   â€¢ Embryo snips: training_data/bf_embryo_snips/{exp_name}/")
    print(f"   â€¢ Uncropped snips: training_data/bf_embryo_snips_uncropped/{exp_name}/")
    print(f"   â€¢ Embryo masks: training_data/bf_embryo_masks/")
    print(f"   â€¢ Metadata: metadata/embryo_metadata_files/{exp_name}_embryo_metadata.csv")
    print("")
    print("ğŸ”„ Next Steps:")
    print("   â€¢ Run Build04 for embryo QC and stage inference")
    print("   â€¢ Run Build05 for final training snip preparation")
    print("   â€¢ Ready for ML model training!")


if __name__ == '__main__':
    multiprocessing.freeze_support()
    main()